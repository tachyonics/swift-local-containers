name: build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
      
jobs:
  BuildTestAndAnalyze:
    name: Image ${{ matrix.image }}
    strategy:
      matrix:
        image: ["swift:6.2.3-noble"]
    runs-on: ubuntu-latest
    container:
      image: ${{ matrix.image }}
    steps:
      - name: Install dependencies
        run: apt-get update && apt-get install -y libssl-dev curl unzip
      - uses: actions/checkout@v6
      - name: Build
        run: swift build -c release -Xswiftc -strict-concurrency=complete
      - name: Run tests
        run: swift test -v 2>&1 | tee build.log
      - name: Install SwiftLint
        run: |
          curl -sL https://github.com/realm/SwiftLint/releases/download/0.63.2/swiftlint_linux_amd64.zip -o swiftlint.zip
          unzip -o swiftlint.zip -d /usr/local/bin
          chmod +x /usr/local/bin/swiftlint
      - name: SwiftLint unused imports
        run: swiftlint analyze --strict --quiet --compiler-log-path build.log
  BuildAndTest:
    name: Image ${{ matrix.image }}
    strategy:
      matrix:
        image: ["swift:6.2.3-jammy"]
    runs-on: ubuntu-latest
    container:
      image: ${{ matrix.image }}
    steps:
      - name: Install libssl-dev
        run: apt-get update && apt-get install -y libssl-dev
      - uses: actions/checkout@v6
      - name: Build
        run: swift build -c release -Xswiftc -strict-concurrency=complete
      - name: Run tests
        run: swift test
  SwiftLint:
    name: SwiftLint version 3.2.1
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: GitHub Action for SwiftLint
        uses: norio-nomura/action-swiftlint@3.2.1
  SwiftFormat:
    name: swift-format
    runs-on: ubuntu-latest
    container:
      image: swift:6.2.3-noble
    steps:
      - uses: actions/checkout@v6
      - name: Run swift-format
        run: swift-format format --recursive --in-place .
      - name: Check for formatting differences
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git diff --exit-code
  Coverage:
    runs-on: ubuntu-latest
    container:
      image: swift:6.2.3-noble
    steps:
      - name: Install dependencies                                                                                                                                              
        run: apt-get update && apt-get install -y curl
      - uses: actions/checkout@v6
      - name: Run tests with coverage
        run: swift test --enable-code-coverage --xunit-output test-results.xml
      - name: Convert to LCOV
        run: |
          BIN_PATH=$(swift build --show-bin-path)
          PROFDATA=$(find .build -name 'default.profdata' -path '*/codecov/*' | head -1)
          XCTEST=$(find "$BIN_PATH" -name '*.xctest' -type f | head -1)
          llvm-cov export \
            -format=lcov \
            -instr-profile="$PROFDATA" \
            "$XCTEST" \
            -ignore-filename-regex=".build|Tests" \
            > coverage.lcov
      - name: Upload coverage
        uses: codecov/codecov-action@v5
        with:
          files: coverage.lcov
          fail_ci_if_error: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      - name: Upload test results
        uses: codecov/codecov-action@v5
        if: always()
        with:
          files: test-results.xml
          report_type: test_results
          fail_ci_if_error: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
  APIBreakage:
    runs-on: ubuntu-latest
    container:
      image: swift:6.2.3-noble
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Check for API breaking changes
        run: |                                                                                                                                                                  
          git config --global --add safe.directory "$GITHUB_WORKSPACE"                                                                                                          
          swift package diagnose-api-breaking-changes origin/main